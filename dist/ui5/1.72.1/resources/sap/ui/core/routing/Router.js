/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/library","sap/ui/base/EventProvider","./HashChanger","./Route","./Views","./Targets","./History","sap/ui/thirdparty/crossroads","sap/base/util/UriParameters","sap/base/util/deepEqual","sap/base/util/isEmptyObject","sap/base/Log","sap/ui/thirdparty/jquery","./RouterHashChanger"],function(t,e,i,s,a,n,h,r,o,u,c,f,d,g){"use strict";var _={};var l=e.extend("sap.ui.core.routing.Router",{constructor:function(t,i,s,n,h){e.apply(this);this._oConfig=i||{};this._oRouter=r.create();this._oRouter.ignoreState=true;this._oRoutes={};this._oOwner=s;function u(){if(o.fromQuery(window.location.search).get("sap-ui-xx-asyncRouting")==="true"){f.warning("Activation of async view loading in routing via url parameter is only temporarily supported and may be removed soon","Router");return true}return false}this._oConfig._async=this._oConfig.async;if(this._oConfig._async===undefined){this._oConfig._async=u()}this._oViews=new a({component:s,async:this._oConfig._async});if(n){this._oTargets=this._createTargets(this._oConfig,n);this._oTargets.attachDisplay(function(t){if(this.isInitialized()&&!this._bMatchingProcessStarted){var e=this.getHashChanger();if(e instanceof g){e.resetHash()}}},this)}var c=this,_;if(!t){t={}}if(Array.isArray(t)){_=t;t={};_.forEach(function(e){t[e.name]=e})}d.each(t,function(t,e){if(e.name===undefined){e.name=t}c.addRoute(e)});this._oRouter.bypassed.add(d.proxy(this._onBypassed,this));if(h){this.setHashChanger(h)}},addRoute:function(t,e){if(!t.name){f.error("A name has to be specified for every route",this)}if(this._oRoutes[t.name]){f.error("Route with name "+t.name+" already exists",this)}this._oRoutes[t.name]=this._createRoute(this,t,e)},parse:function(t){if(this._oRouter){this._oRouter.parse(t)}else{f.warning("This router has been destroyed while the hash changed. No routing events where fired by the destroyed instance.",this)}},initialize:function(t){var e=this,s;if(!this.oHashChanger){this.oHashChanger=i.getInstance().createRouterHashChanger()}if(this._bIsInitialized){f.warning("Router is already initialized.",this);return this}this._bIsInitialized=true;this._bLastHashReplaced=false;this._bHashChangedAfterTitleChange=false;this.fnHashChanged=function(t){e.parse(t.getParameter("newHash"));e._bHashChangedAfterTitleChange=true};if(!this.oHashChanger){f.error("navTo of the router is called before the router is initialized. If you want to replace the current hash before you initialize the router you may use getUrl and use replaceHash of the Hashchanger.",this);return this}if(this._oTargets){var a=this._oRoutes[this._oConfig.homeRoute];this._oTargets.attachTitleChanged(function(t){var e=t.getParameters();if(a&&p(e.name,a._oConfig.name)){e.isHome=true}this.fireTitleChanged(e)},this);this._aHistory=[];var n=a&&R(this._oOwner,a);if(n){this._aHistory.push(n)}}this.oHashChanger.init();s=this.oHashChanger.getHash();this.oHashChanger.attachEvent("hashChanged",this.fnHashChanged);if(!t&&s!==g.InvalidHash){this.parse(s)}return this},stop:function(){if(!this._bIsInitialized){f.warning("Router is not initialized. But it got stopped",this)}if(this.fnHashChanged){this.oHashChanger.detachEvent("hashChanged",this.fnHashChanged)}if(this.fnHashReplaced){this.oHashChanger.detachEvent("hashReplaced",this.fnHashReplaced)}if(this._matchedRoute){this._matchedRoute.fireEvent("switched");this._matchedRoute=null}this._bIsInitialized=false;return this},isStopped:function(){return this._bIsInitialized===false},isInitialized:function(){return this._bIsInitialized===true},getHashChanger:function(){return this.oHashChanger},setHashChanger:function(t){if(this.oHashChanger){f.warning("The Router already has a HashChanger set and this call is ignored")}else{this.oHashChanger=t}return this},destroy:function(){if(this.bIsDestroyed){return this}e.prototype.destroy.apply(this);if(this._oViews){this._oViews.destroy();this._oViews=null}if(!this._bIsInitialized){f.info("Router is not initialized, but got destroyed.",this)}if(this.fnHashChanged){this.oHashChanger.detachEvent("hashChanged",this.fnHashChanged)}if(this.fnHashReplaced){this.oHashChanger.detachEvent("hashReplaced",this.fnHashReplaced)}this._oRouter.removeAllRoutes();this._oRouter=null;d.each(this._oRoutes,function(t,e){e.destroy()});this._oRoutes=null;this._oConfig=null;if(this._oTargets){this._oTargets.destroy();this._oTargets=null}delete this._bIsInitialized;this.bIsDestroyed=true;return this},getURL:function(t,e){var i=this.getRoute(t);if(!i){f.warning("Route with name "+t+" does not exist",this);return}return i.getURL(e)},match:function(t){return Object.keys(this._oRoutes).some(function(e){return this._oRoutes[e].match(t)}.bind(this))},getRoute:function(t){return this._oRoutes[t]},getViews:function(){return this._oViews},_createTargets:function(t,e){return new n({views:this._oViews,config:t,targets:e})},_createRoute:function(t,e,i){return new s(t,e,i)},getView:function(t,e,i){f.warning("Deprecated API Router#getView called - use Router#getViews instead.",this);var s=this._oViews._getViewWithGlobalId({viewName:t,type:e,id:i});this.fireViewCreated({view:s,viewName:t,type:e});return s},setView:function(t,e){this._oViews.setView(t,e);return this},navTo:function(t,e,i,s){var a=this,n=this._getLastMatchedRouteName()!==t,h=this.getRoute(t),r,o;if(!h){f.warning("Route with name "+t+" does not exist",this);return this}if(typeof i==="boolean"){s=i}if(e===undefined){e={}}if(i&&!c(i)){if(!this._oConfig._async){f.error("navTo with component target info is only supported with async router",this);return this}r=h._changeHashWithComponentTargets(i,n)}o=h.getURL(e);if(s){a._bLastHashReplaced=true;a.oHashChanger.replaceHash(o,r,!n)}else{a.oHashChanger.setHash(o,r,!n)}return this},_getLastMatchedRouteName:function(){return this._matchedRoute&&this._matchedRoute._oConfig.name},getTargets:function(){return this._oTargets},getTarget:function(t){return this._oTargets.getTarget(t)},attachRouteMatched:function(t,e,i){this.attachEvent("routeMatched",t,e,i);return this},detachRouteMatched:function(t,e){this.detachEvent("routeMatched",t,e);return this},fireRouteMatched:function(t){this.fireEvent("routeMatched",t);if(l._interceptRouteMatched){l._interceptRouteMatched(this._oConfig.controlId,this)}return this},attachBeforeRouteMatched:function(t,e,i){this.attachEvent("beforeRouteMatched",t,e,i);return this},detachBeforeRouteMatched:function(t,e){this.detachEvent("beforeRouteMatched",t,e);return this},fireBeforeRouteMatched:function(t){this.fireEvent("beforeRouteMatched",t);return this},attachViewCreated:function(t,e,i){this.attachEvent("viewCreated",t,e,i);return this},detachViewCreated:function(t,e){this.detachEvent("viewCreated",t,e);return this},fireViewCreated:function(t){this.fireEvent("viewCreated",t);return this},attachRoutePatternMatched:function(t,e,i){this.attachEvent("routePatternMatched",t,e,i);return this},detachRoutePatternMatched:function(t,e){this.detachEvent("routePatternMatched",t,e);return this},fireRoutePatternMatched:function(t){this.fireEvent("routePatternMatched",t);return this},attachBypassed:function(t,e,i){return this.attachEvent(l.M_EVENTS.BYPASSED,t,e,i)},detachBypassed:function(t,e){return this.detachEvent(l.M_EVENTS.BYPASSED,t,e)},fireBypassed:function(t){return this.fireEvent(l.M_EVENTS.BYPASSED,t)},attachTitleChanged:function(t,e,i){this.attachEvent(l.M_EVENTS.TITLE_CHANGED,t,e,i);return this},detachTitleChanged:function(t,e){return this.detachEvent(l.M_EVENTS.TITLE_CHANGED,t,e)},fireTitleChanged:function(e){var i=h.getInstance().getDirection(),s=this.oHashChanger.getHash(),a=t.routing.HistoryDirection,n=this._aHistory[this._aHistory.length-1],r;if(i===a.Backwards&&n&&!n.isHome){if(n&&n.title!==e.title){this._aHistory.pop()}}else if(n&&n.hash==s){n.title=e.title;this._aHistory.some(function(t,e,i){if(e<i.length-1&&u(t,n)){return i.splice(e,1)}})}else{if(this._bLastHashReplaced){this._aHistory.pop()}r={hash:s,title:e.title};this._aHistory.some(function(t,e,i){if(u(t,r)){return i.splice(e,1)}});this._aHistory.push(r)}e.history=this._aHistory.slice(0,-1);this.fireEvent(l.M_EVENTS.TITLE_CHANGED,e);this._bLastHashReplaced=false;return this},getTitleHistory:function(){return this._aHistory||[]},register:function(t){_[t]=this;return this},_onBypassed:function(t){var e=function(){this.fireBypassed({hash:t})}.bind(this);if(this._oConfig.bypassed){var i=this._oTargets.display(this._oConfig.bypassed.target,{hash:t});if(i instanceof Promise){i.then(e);return}}e()},_isAsync:function(){return this._oConfig._async},metadata:{publicMethods:["initialize","getURL","register","getRoute"]}});function p(t,e){return e&&e.indexOf(t)>-1}function R(t,e){var i=e.getPattern(),s=t&&t.getManifestEntry("sap.app/title");if(i===""||i!==undefined&&!/({.*})+/.test(i)){return{hash:i,isHome:true,title:s}}else{f.error("Routes with dynamic parts cannot be resolved as home route.")}}l.M_EVENTS={BEFORE_ROUTE_MATCHED:"beforeRouteMatched",ROUTE_MATCHED:"routeMatched",ROUTE_PATTERN_MATCHED:"routePatternMatched",VIEW_CREATED:"viewCreated",BYPASSED:"bypassed",TITLE_CHANGED:"titleChanged"};l._interceptRouteMatched=undefined;l.getRouter=function(t){return _[t]};return l});