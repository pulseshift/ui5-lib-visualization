/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./BaseTreeModifier","sap/ui/base/ManagedObject","sap/base/util/merge","sap/ui/util/XMLHelper","sap/ui/core/mvc/EventHandlerResolver","sap/base/util/includes","sap/base/util/ObjectPath","sap/base/util/isPlainObject","sap/ui/core/Fragment"],function(t,e,r,n,i,a,o,g){"use strict";var s={targets:"xmlTree",setVisible:function(t,e){if(e){t.removeAttribute("visible")}else{t.setAttribute("visible",e)}},getVisible:function(t){return this.getProperty(t,"visible")},setStashed:function(t,e){if(!e){t.removeAttribute("stashed")}else{t.setAttribute("stashed",e)}this.setVisible(t,!e)},getStashed:function(t){return this.getProperty(t,"stashed")},bindProperty:function(t,e,r){t.setAttribute(e,"{"+r+"}")},unbindProperty:function(t,e){t.removeAttribute(e)},setProperty:function(t,e,r){var n=r;if(g(r)){n=JSON.stringify(r)}t.setAttribute(e,n)},getProperty:function(t,r){var n=t.getAttribute(r);var i=this.getControlMetadata(t).getProperty(r);if(i){var a=i.getType();if(n===null){n=i.getDefaultValue()||a.getDefaultValue()}else{var o=e.bindingParser(n,undefined,true);if(g(o)){if(o.path||o.parts){n=undefined}else{n=o}}else{n=a.parseValue(o||n)}}}return n},isPropertyInitial:function(t,e){var r=t.getAttribute(e);return r==null},setPropertyBinding:function(t,e,r){if(typeof r!=="string"){throw new Error("For XML, only strings are supported to be set as property binding.")}t.setAttribute(e,r)},getPropertyBinding:function(t,r){var n=t.getAttribute(r);if(n){var i=e.bindingParser(n,undefined,true);if(i&&(i.path||i.parts)){return i}}},createControl:function(t,e,r,n,i,a){var o,g,s;if(!this.bySelector(n,e,r)){var u=t.split(".");var l="";if(u.length>1){g=u.pop();l=u.join(".")}var f=r.ownerDocument.createElementNS(l,g);o=this.getControlIdBySelector(n,e);if(o){f.setAttribute("id",o)}if(i){this.applySettings(f,i)}return a?Promise.resolve(f):f}else{s=new Error("Can't create a control with duplicated ID "+o);if(a){return Promise.reject(s)}throw s}},applySettings:function(t,e){var r=this.getControlMetadata(t);var n=r.getJSONKeys();Object.keys(e).forEach(function(r){var i=n[r];var a=e[r];switch(i._iKind){case 0:this.setProperty(t,r,a);break;case 3:this.setAssociation(t,r,a);break;default:throw new Error("Unsupported in applySettings on XMLTreeModifier: "+r)}}.bind(this))},_byId:function(t,e){if(e){if(e.ownerDocument&&e.ownerDocument.getElementById&&e.ownerDocument.getElementById(t)){return e.ownerDocument.getElementById(t)}else{return e.querySelector("[id='"+t+"']")}}},getId:function(t){return t.getAttribute("id")},getParent:function(t){var e=t.parentNode;if(!this.getId(e)){e=e.parentNode}return e},_getLocalName:function(t){return t.localName||t.baseName||t.nodeName},getControlType:function(t){return this._getControlTypeInXml(t)},setAssociation:function(t,e,r){if(typeof r!=="string"){r=this.getId(r)}t.setAttribute(e,r)},getAssociation:function(t,e){return t.getAttribute(e)},getAllAggregations:function(t){var e=this.getControlMetadata(t);return e.getAllAggregations()},getAggregation:function(t,e){var r=this._findAggregationNode(t,e);var n=this._isSingleValueAggregation(t,e);if(!r){if(n&&this._isAltTypeAggregation(t,e)){return this.getProperty(t,e)}return n?undefined:[]}var i=this._getControlsInAggregation(t,r);if(n){return i[0]}return i},insertAggregation:function(t,e,r,n,i){var a=this._findAggregationNode(t,e);if(!a){var o=t.namespaceURI;a=this.createControl(o+"."+e,undefined,i);t.appendChild(a)}if(n>=a.childElementCount){a.appendChild(r)}else{var g=this._getControlsInAggregation(t,a)[n];a.insertBefore(r,g)}},removeAggregation:function(t,e,r){var n=this._findAggregationNode(t,e);n.removeChild(r)},removeAllAggregation:function(t,e){var r=this._findAggregationNode(t,e);if(t===r){var n=this._getControlsInAggregation(t,t);n.forEach(function(e){t.removeChild(e)})}else{t.removeChild(r)}},_findAggregationNode:function(t,e){var r;var n=this._children(t);for(var i=0;i<n.length;i++){var a=n[i];if(a.localName===e){r=a;break}}if(!r&&this._isDefaultAggregation(t,e)){r=t}return r},_isDefaultAggregation:function(t,e){var r=this.getControlMetadata(t);var n=r.getDefaultAggregation();return n&&e===n.name},_isNotNamedAggregationNode:function(t,e){var r=this.getAllAggregations(t);var n=r[e.localName];return t.namespaceURI!==e.namespaceURI||!n},_isSingleValueAggregation:function(t,e){var r=this.getAllAggregations(t);var n=r[e];return!n.multiple},_isAltTypeAggregation:function(t,e){var r=this.getControlMetadata(t);var n=r.getAllAggregations()[e];return!!n.altTypes},getControlMetadata:function(t){return this._getControlMetadataInXml(t)},_getControlsInAggregation:function(t,e){var r=Array.prototype.slice.call(this._children(e));return r.filter(this._isNotNamedAggregationNode.bind(this,t))},_children:function(t){if(t.children){return t.children}else{var e=[];for(var r=0;r<t.childNodes.length;r++){var n=t.childNodes[r];if(n.nodeType===n.ELEMENT_NODE){e.push(n)}}return e}},getBindingTemplate:function(t,e){var r=this._findAggregationNode(t,e);if(r){var n=this._children(r);if(n.length===1){return n[0]}}},updateAggregation:function(t,e){},findIndexInParentAggregation:function(t){var e,r,n;e=this.getParent(t);if(!e){return-1}r=this.getParentAggregationName(t,e);n=this.getAggregation(e,r);if(Array.isArray(n)){return n.indexOf(t)}else{return 0}},getParentAggregationName:function(t,e){var r,n;if(!e.isSameNode(t.parentNode)){r=false}else{r=this._isNotNamedAggregationNode(e,t)}if(r){n=this.getControlMetadata(e).getDefaultAggregationName()}else{n=this._getLocalName(t.parentNode)}return n},findAggregation:function(t,e){var r=this.getControlMetadata(t);var n=r.getAllAggregations();if(n){return n[e]}},validateType:function(t,e,r,n,i){var a=e.type;if(e.multiple===false&&this.getAggregation(r,e.name)&&this.getAggregation(r,e.name).length>0){return false}var o=sap.ui.xmlfragment({fragmentContent:n});if(!Array.isArray(o)){o=[o]}var g=this._isInstanceOf(o[i],a)||this._hasInterface(o[i],a);o.forEach(function(t){t.destroy()});return g},instantiateFragment:function(t,e,r){var i;var a=n.parse(t);a=this._checkAndPrefixIdsInFragment(a,e);if(a.localName==="FragmentDefinition"){i=this._getElementNodeChildren(a)}else{i=[a]}i.forEach(function(t){if(this._byId(t.getAttribute("id"),r)){throw Error("The following ID is already in the view: "+t.getAttribute("id"))}}.bind(this));return i},destroy:function(t){var e=t.parentNode;if(e){e.removeChild(t)}},getChangeHandlerModulePath:function(t){if(!t){return undefined}return t.getAttributeNS("sap.ui.fl","flexibility")},attachEvent:function(t,e,r,n){if(typeof o.get(r)!=="function"){throw new Error("Can't attach event because the event handler function is not found or not a function.")}var g=this.getProperty(t,e)||"";var s=i.parse(g);var u=r;var l=["$event"];if(n){l.push(JSON.stringify(n))}u+="("+l.join(",")+")";if(!a(s,u)){s.push(u)}t.setAttribute(e,s.join(";"))},detachEvent:function(t,e,r){if(typeof o.get(r)!=="function"){throw new Error("Can't attach event because the event handler function is not found or not a function.")}var n=this.getProperty(t,e)||"";var a=i.parse(n);var g=a.findIndex(function(t){return t.includes(r)});if(g>-1){a.splice(g,1)}if(a.length){t.setAttribute(e,a.join(";"))}else{t.removeAttribute(e)}},bindAggregation:function(t,e,r,n){this.bindProperty(t,e,r.path);this.insertAggregation(t,e,r.template,0,n)},unbindAggregation:function(t,e){if(t.hasAttribute(e)){t.removeAttribute(e);this.removeAllAggregation(t,e)}}};return r({},t,s)},true);