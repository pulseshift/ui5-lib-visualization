/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/isEmptyObject","sap/ui/core/Component","sap/ui/core/Element","sap/ui/core/Shortcut"],function(e,t,i,n,r){"use strict";var a=n.extend("sap.ui.core.CommandExecution",{metadata:{library:"sap.ui.core",properties:{command:{type:"string"},enabled:{type:"boolean",defaultValue:true},visible:{type:"boolean",defaultValue:true}},events:{execute:{}}},trigger:function(){if(this.getVisible()&&this.getEnabled()){this.fireExecute({})}},setCommand:function(t){if(!this.getCommand()){this.setProperty("command",t,true)}else{e.error("The 'command' property can only be applied initially!")}return this},_getCommandInfo:function(){var e,t=this.getParent(),n=i.getOwnerComponentFor(this);while(!n&&t&&t.getParent()){n=i.getOwnerComponentFor(t);t=t.getParent()}if(n){e=n.getCommand(this.getCommand())}return e?Object.assign({},e):null},_createCommandData:function(e){var t=this.getParent(),i=t.getBindingContext("$cmd"),n=t.getModel("$cmd"),r=n.getData(),a=r[t.getId()];if(!a){e=i&&i.getObject();a=Object.create(e||null)}else if(e&&e!==Object.getPrototypeOf(a)){a=Object.create(e)}else if(a[this.getCommand()]){return}a[this.getCommand()]={};a[this.getCommand()].enabled=this.getEnabled();a[this.getCommand()].visible=this.getVisible();n.setProperty("/"+t.getId(),a);this.bindProperty("enabled",{path:"$cmd>"+this.getCommand()+"/enabled"});this.bindProperty("visible",{path:"$cmd>"+this.getCommand()+"/visible"});t.bindElement("$cmd>/"+t.getId())},setParent:function(e){var t=this,i,a=this.getParent(),o,s;n.prototype.setParent.apply(this,arguments);i=this._getCommandInfo();function g(){if(e.getModel("$cmd")){t._createCommandData();t.getParent().detachModelContextChange(g)}}if(i&&this.getVisible()){if(e&&e!==a){o=i.shortcut;s=r.isRegistered(this.getParent(),o);if(!s){r.register(e,o,this.trigger.bind(this))}if(e.getModel("$cmd")){this._createCommandData()}else{e.attachModelContextChange(g)}var d=e._propagateProperties;e._propagateProperties=function(){var i=e.oPropagatedProperties;var n=i.oBindingContexts["$cmd"];var r=t.getBindingContext("$cmd");if(n&&r&&n!==r){t._createCommandData(n.getObject())}d.apply(e,arguments)};e._propagateProperties._sapui_fnOrig=d}if(a&&a!=e){o=i.shortcut;s=r.isRegistered(a,o);if(s){r.unregister(a,i.shortcut)}this._cleanupContext(a)}}return this},_cleanupContext:function(e){if(e.getBindingContext("$cmd")){var i=e.getBindingContext("$cmd").getObject();if(i){delete i[this.getCommand()]}if(t(Object.assign({},i))){e._propagateProperties=e._propagateProperties._sapui_fnOrig;e.unbindElement("$cmd")}}},setVisible:function(e){var t=this.getParent();this.setProperty("visible",e,true);if(t){var i=this._getCommandInfo();var n=i.shortcut;var a=r.isRegistered(this.getParent(),n);if(e&&!a){r.register(t,n,this.trigger.bind(this))}else if(!e&&a){r.unregister(t,n)}}return this},destroy:function(){var e=this.getParent();if(e){var t=this._getCommandInfo();r.unregister(this.getParent(),t.shortcut);this._cleanupContext(e)}n.prototype.destroy.apply(this,arguments)}});a.find=function(e,t){var i,n,r;r=e.getDependents();for(i=0;i<r.length;i++){if(r[i].isA("sap.ui.core.CommandExecution")&&r[i].getCommand()===t){n=r[i]}}if(!n&&e.getParent()){n=a.find(e.getParent(),t)}return n};return a});