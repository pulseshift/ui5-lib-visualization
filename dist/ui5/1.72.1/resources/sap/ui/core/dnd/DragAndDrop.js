/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","../UIArea","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/control"],function(t,e,r){"use strict";var n={},i=null,o=null,a=null,f=[],g=[],u=null,s,l,d,p,c={};function h(t,e){if(!t){return}if(t.addStyleClass){t.addStyleClass(e)}else{t.$().addClass(e)}}function D(t,e){if(!t){return}if(t.removeStyleClass){t.removeStyleClass(e)}else{t.$().removeClass(e)}}function v(t,e){var n=r(t.target).control(0,true);if(!n){return}var i=r.Event(null,t);i.type=e;n.getUIArea()._handleEvent(i)}function m(e,n){if(t.browser.msie||!e||!e.getDragGhost){return}var i=e.getDragGhost();if(!i){return}if(!l){l=r('<div class="sapUiDnDGhostContainer"></div>');r(document.body).append(l)}l.append(i);window.setTimeout(function(){l.empty()},0);var o=n.originalEvent;o.dataTransfer.setDragImage(i,o.offsetX,o.offsetY)}function w(e){var r={},n,o=e.originalEvent.dataTransfer,f=function(e,r){if(o&&e=="text"||t.browser!="msie"&&t.browser!="edge"){o.setData(e,r)}};return({setData:function(t,e){e=""+e;r[t]=e;f(t,e)},getData:function(t){return r[t]},setTextData:function(t){t=""+t;r["text/plain"]=t;r["text"]=t;f("text/plain",t);f("text",t)},getTextData:function(){return r["text/plain"]},setComplexData:function(t,e){r[t]=e},getComplexData:function(t){return r[t]},getIndicator:function(){return s&&s[0]},setIndicatorConfig:function(t){n=t},getIndicatorConfig:function(t){return n},getDragControl:function(){return i},getDropControl:function(){return a},setDropControl:function(t){a=t},getDropInfo:function(){return g[0]||null},getDropPosition:function(){return d}})}function C(t){b();D(i,"sapUiDnDDragging");i=o=a=u=null;d="";f=[];g=[]}function E(){if(s){return s}s=r("<div class='sapUiDnDIndicator'></div>");r(sap.ui.getCore().getStaticAreaRef()).append(s);return s}function b(){if(s){s.removeAttr("style").hide();c={}}}function y(t,e,n,i){if(!e){return}var o=t.dragSession&&t.dragSession.getIndicatorConfig(),a=e.getBoundingClientRect(),f=window.pageYOffset,g=window.pageXOffset,u=E(),s,l={},d={top:a.top+f,bottom:a.bottom+f,left:a.left+g,right:a.right+g,width:a.width,height:a.height};if(!n||n=="On"){s="On";i=""}else if(i=="Horizontal"){var p=t.pageX-d.left;l.height=d.height;l.top=d.top;if(n=="Between"){l.width="";if(p<d.width*.5){s="Before";l.left=d.left}else{s="After";l.left=d.right}}else if(n=="OnOrBetween"){if(p<d.width*.25){s="Before";l.left=d.left;l.width=""}else if(p>d.width*.75){s="After";l.left=d.right;l.width=""}else{s="On"}}if(s!="On"&&sap.ui.getCore().getConfiguration().getRTL()){s=s=="After"?"Before":"After"}}else{var h=t.pageY-d.top;l.width=d.width;l.left=d.left;if(n=="Between"){l.height="";if(h<d.height*.5){s="Before";l.top=d.top}else{s="After";l.top=d.bottom}}else if(n=="OnOrBetween"){if(h<d.height*.25){s="Before";l.top=d.top;l.height=""}else if(h>d.height*.75){s="After";l.top=d.bottom;l.height=""}else{s="On"}}}if(o&&o.display=="none"){return s}if(s=="On"){l.top=d.top;l.left=d.left;l.width=d.width;l.height=d.height;n=s}else{n="Between"}if(c.top!=l.top||c.left!=l.left||c.width!=l.width||c.height!=l.height){u.attr("data-drop-layout",i);u.attr("data-drop-position",n);u.css(r.extend(l,o)).show();c=l}return s}function x(t){var e=t.getParent(),r=t.getDragDropConfig?t.getDragDropConfig():[],n=e&&e.getDragDropConfig?e.getDragDropConfig():[];return r.concat(n)}function A(t){var e=x(t);return e.filter(function(e){return e.isDraggable(t)})}function O(t,e,r){var n=x(t);e=e||[];return n.filter(function(t){return!t.isA("sap.ui.core.dnd.IDragInfo")}).concat(e).filter(function(n){if(!n.isDroppable(t,r)){return false}var i=n.getGroupName();if(!i){return true}return e.some(function(t){return t.getGroupName()==i})})}function S(t,e){t.preventDefault();var r=e.getDropEffect().toLowerCase();t.originalEvent.dataTransfer.dropEffect=r}function T(t,e,r){var n=e.getTargetAggregation();if(!n){return y(t,r.getDomRef())}var i;if(t.getMark("DragWithin")==n){i=r.getDomRefForSetting(n)}i=i||r.getDomRef();return y(t,i,e.getDropPosition(true),e.getDropLayout(true))}n.preprocessEvent=function(t){if(u&&t.type.indexOf("dr")==0){t.dragSession=u}var e="onbefore"+t.type;if(n[e]){n[e](t)}};n.postprocessEvent=function(t){var e="onafter"+t.type;if(n[e]){n[e](t)}};n.onbeforedragstart=function(e){if(!e.target.draggable){return}if(/^(input|textarea)$/i.test(document.activeElement.tagName)){e.target.getAttribute("data-sap-ui-draggable")&&e.preventDefault();return}i=r(e.target).control(0,true);if(!i){return}f=A(i);if(!f.length){return}if(t.browser.firefox&&e.originalEvent.dataTransfer.types.length===0){e.originalEvent.dataTransfer.setData("ui5/dummyDataForFirefox","data")}e.dragSession=u=w(e)};n.onafterdragstart=function(t){if(!f.length||t.isDefaultPrevented()){C();return}f=t.isMarked("NonDraggable")?[]:f.filter(function(e){return e.fireDragStart(t)});if(!f.length){t.preventDefault();C();return}m(i,t);h(i,"sapUiDnDDragging")};n.onbeforedragenter=function(t){var e=r(t.target).control(0,true);if(e&&o===e){t.setMark("DragWithin","SameControl")}else{p=Date.now();o=e}var n=[];a=e;for(var i=0;i<20&&a;i++,a=a.getParent()){n=O(a,f,t);if(n.length){break}}if(t.getMark("DragWithin")!="SameControl"){g=n;if(u){u.setIndicatorConfig(null)}}if(!g.length){a=null}else if(!u){t.dragSession=u=w(t)}};n.onafterdragenter=function(t){if(!a||t.isMarked("NonDroppable")){g=[]}else if(t.getMark("DragWithin")!="SameControl"){g=g.filter(function(e){return e.fireDragEnter(t)})}var e=g[0];if(!e||e.getDropEffect()=="None"){b();d=""}else{S(t,e);d=T(t,e,a)}};n.onbeforedragover=function(t){var e=Date.now();if(e-p>=1e3){v(t,"longdragover");p=e}};n.onafterdragover=function(t){var e=g[0];if(!e||e.getDropEffect()=="None"){return}g.forEach(function(e){e.fireDragOver(t)});S(t,e);if(e&&e.getDropPosition(true)=="On"){return}d=T(t,e,a)};n.onbeforedrop=function(t){if(g.length){t.preventDefault()}};n.onafterdrop=function(t){g.forEach(function(e){e.fireDrop(t)});this.iDragEndTimer=window.requestAnimationFrame(this.onafterdragend.bind(this,t))};n.onafterdragend=function(t){this.iDragEndTimer=window.cancelAnimationFrame(this.iDragEndTimer);f.forEach(function(e){e.fireDragEnd(t)});C()};e.addEventPreprocessor(n.preprocessEvent);e.addEventPostprocessor(n.postprocessEvent);return n},true);