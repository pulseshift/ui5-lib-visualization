/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_GroupLock","./_Helper","./_Requestor","sap/base/Log","sap/base/util/isEmptyObject","sap/ui/base/SyncPromise","sap/ui/thirdparty/jquery"],function(e,t,n,i,r,s,o){"use strict";var a=/\(\$uid=[-\w]+\)$/,u="@com.sap.vocabularies.Common.v1.Messages",h=/^-?\d+$/,l=/^([^(]*)(\(.*\))$/;function f(e,t,n,i){if(n.$count!==undefined){d(e,t,n,n.$count+i)}}function c(e,t){return t===""||e===t||e.indexOf(t+"/")===0}function d(e,n,i,r){if(typeof r==="string"){r=parseInt(r)}t.updateExisting(e,n,i,{$count:r})}function p(e,n,i,r,s){this.bActive=true;this.mChangeListeners={};this.fnGetOriginalResourcePath=s;this.mLateQueryOptions=null;this.sMetaPath=t.getMetaPath("/"+n);this.mPatchRequests={};this.oPendingRequestsPromise=null;this.mPostRequests={};this.mPropertyRequestByPath={};this.oRequestor=e;this.sResourcePath=n;this.bSortExpandSelect=r;this.bSentReadRequest=false;this.oTypePromise=undefined;this.setQueryOptions(i)}p.prototype._delete=function(n,i,r,s,o){var a=r.split("/"),u=a.pop(),h=a.join("/"),l=this;this.addPendingRequest();return this.fetchValue(e.$cached,h).then(function(e){var r=u?e[p.from$skip(u,e)]:e,a,f=t.getPrivateAnnotation(r,"predicate"),c=t.buildPath(h,Array.isArray(e)?f:u),d=t.getPrivateAnnotation(r,"transient");if(d===true){throw new Error("No 'delete' allowed while waiting for server response")}if(d){n.unlock();l.oRequestor.removePost(d,r);return undefined}if(r["$ui5.deleting"]){throw new Error("Must not delete twice: "+i)}r["$ui5.deleting"]=true;a={"If-Match":s||r};i+=l.oRequestor.buildQueryString(l.sMetaPath,l.mQueryOptions,true);return l.oRequestor.request("DELETE",i,n,a,undefined,undefined,undefined,undefined,t.buildPath(l.getOriginalResourcePath(r),c)).catch(function(e){if(e.status!==404){delete r["$ui5.deleting"];throw e}}).then(function(){if(Array.isArray(e)){o(l.removeElement(e,Number(u),f,h),e)}else{if(u){t.updateExisting(l.mChangeListeners,h,e,p.makeUpdateData([u],null))}else{r["$ui5.deleted"]=true}o()}l.oRequestor.getModelInterface().reportBoundMessages(l.sResourcePath,[],[c])})}).finally(function(){l.removePendingRequest()})};p.prototype.addPendingRequest=function(){var e;if(!this.oPendingRequestsPromise){this.oPendingRequestsPromise=new s(function(t){e=t});this.oPendingRequestsPromise.$count=0;this.oPendingRequestsPromise.$resolve=e}this.oPendingRequestsPromise.$count+=1};p.prototype.calculateKeyPredicate=function(e,n,i){var r,s=n[i];if(s&&s.$Key){r=t.getKeyPredicate(e,i,n);if(r){t.setPrivateAnnotation(e,"predicate",r)}}return r};p.prototype.checkActive=function(){var e;if(!this.bActive){e=new Error("Response discarded: cache is inactive");e.canceled=true;throw e}};p.prototype.create=function(e,i,r,a,u,h,l,c){var d,p=u&&u["@$ui5.keepTransientPath"],P=this;function g(){t.removeByPath(P.mPostRequests,r,u);d.splice(d.indexOf(u),1);d.$created-=1;f(P.mChangeListeners,r,d,-1);delete d.$byPredicate[a];if(!r){P.adjustReadRequests(0,-1)}h()}function y(){P.addPendingRequest();t.setPrivateAnnotation(u,"transient",true);c()}function m(e,n){var i=n.getGroupId();t.setPrivateAnnotation(u,"transient",i);t.addByPath(P.mPostRequests,r,u);return s.all([P.oRequestor.request("POST",e,n,null,u,y,g,undefined,t.buildPath(P.sResourcePath,r,a)),P.fetchTypes()]).then(function(e){var n=e[0],i;t.deletePrivateAnnotation(u,"transient");u["@$ui5.context.isTransient"]=false;t.removeByPath(P.mPostRequests,r,u);P.visitResponse(n,e[1],t.getMetaPath(t.buildPath(P.sMetaPath,r)),r+a,p);if(!p){i=t.getPrivateAnnotation(n,"predicate");if(i){d.$byPredicate[i]=u;t.updateTransientPaths(P.mChangeListeners,a,i)}}t.updateSelected(P.mChangeListeners,t.buildPath(r,i||a),u,n,t.getQueryOptionsForPath(P.mQueryOptions,r).$select);P.removePendingRequest();return u},function(t){if(t.canceled){throw t}P.removePendingRequest();l(t);return m(e,P.oRequestor.lockGroup(P.oRequestor.getGroupSubmitMode(i)==="API"?i:"$parked."+i,P,true,true))})}u=o.extend(true,{},u);u=n.cleanPayload(u);t.setPrivateAnnotation(u,"transientPredicate",a);u["@$ui5.context.isTransient"]=true;d=this.getValue(r);if(!Array.isArray(d)){throw new Error("Create is only supported for collections; '"+r+"' does not reference a collection")}d.unshift(u);d.$created+=1;f(this.mChangeListeners,r,d,1);d.$byPredicate=d.$byPredicate||{};d.$byPredicate[a]=u;if(!r){P.adjustReadRequests(0,1)}return i.then(function(t){t+=P.oRequestor.buildQueryString(P.sMetaPath,P.mQueryOptions,true);return m(t,e)})};p.prototype.deregisterChange=function(e,n){t.removeByPath(this.mChangeListeners,e,n)};p.prototype.drillDown=function(e,n,r){var o=s.resolve(e),a,u,h,f=false,c=this;function d(e){i.error("Failed to drill-down into "+n+", invalid segment: "+e,c.toString(),"sap.ui.model.odata.v4.lib._Cache");return undefined}function P(e,i,s){var o=n.split("/").slice(0,s).join("/"),l,p;if(Array.isArray(e)){return d(i)}return c.oRequestor.getModelInterface().fetchMetadata(c.sMetaPath+"/"+t.getMetaPath(o)).then(function(n){if(!n){return d(i)}if(n.$Type==="Edm.Stream"){l=e[i+"@odata.mediaReadLink"];p=c.oRequestor.getServiceUrl();return l||t.buildPath(p+c.sResourcePath,o)}if(!f){if(r&&a&&n.$kind==="Property"){return c.fetchLateProperty(r,a,h.slice(0,u).join("/"),h.slice(u).join("/"),h.slice(u,s).join("/"))}return d(i)}if(n.$kind==="NavigationProperty"){return null}if(!n.$Type.startsWith("Edm.")){return{}}if("$DefaultValue"in n){return n.$Type==="Edm.String"?n.$DefaultValue:t.parseLiteral(n.$DefaultValue,n.$Type,o)}return null})}if(!n){return o}h=n.split("/");return h.reduce(function(e,n,i){return e.then(function(e){var r,s;if(n==="$count"){return Array.isArray(e)?e.$count:d(n)}if(e===undefined||e===null){return undefined}if(typeof e!=="object"||n==="@$ui5._"){return d(n)}if(t.getPrivateAnnotation(e,"predicate")){a=e;u=i}s=e;f=f||t.getPrivateAnnotation(e,"transient");r=l.exec(n);if(r){if(r[1]){e=e[r[1]]}if(e){e=e.$byPredicate[r[2]]}}else{e=e[p.from$skip(n,e)]}return e===undefined&&n[0]!=="#"&&n[0]!=="@"?P(s,n,i+1):e})},o)};p.prototype.fetchLateProperty=function(e,n,i,r,s){var o,a=Object.assign({},this.mQueryOptions),u,h=this;this.mLateQueryOptions=this.mLateQueryOptions||t.merge({},this.mQueryOptions);if(this.mLateQueryOptions.$select.indexOf(r)<0){this.mLateQueryOptions.$select.push(r)}delete a.$apply;delete a.$count;delete a.$expand;delete a.$filter;delete a.$orderby;delete a.$search;a.$select=r;u=t.buildPath(this.sResourcePath,i)+this.oRequestor.buildQueryString(this.sMetaPath,a);o=this.mPropertyRequestByPath[u];if(!o){o=this.oRequestor.request("GET",u,e).then(function(e){if(e["@odata.etag"]!==n["@odata.etag"]){throw new Error("GET "+u+": ETag changed")}t.updateAll(h.mChangeListeners,i,n,e);return t.drillDown(n,s.split("/"))}).finally(function(){delete h.mPropertyRequestByPath[u]});this.mPropertyRequestByPath[u]=o}return o};p.prototype.fetchTypes=function(){var e,t,n=this;function i(e,t){if(t&&t.$expand){Object.keys(t.$expand).forEach(function(n){var s=e;n.split("/").forEach(function(e){s+="/"+e;r(s)});i(s,t.$expand[n])})}}function r(i){e.push(n.oRequestor.fetchTypeForPath(i).then(function(e){var s=n.oRequestor.getModelInterface().fetchMetadata(i+"/"+u).getResult();if(s){e=Object.create(e);e[u]=s}t[i]=e;if(e&&e.$Key){e.$Key.forEach(function(e){var t,n;if(typeof e!=="string"){n=e[Object.keys(e)[0]];t=n.lastIndexOf("/");if(t>=0){r(i+"/"+n.slice(0,t))}}})}}))}if(!this.oTypePromise){e=[];t={};r(this.sMetaPath);if(this.bFetchOperationReturnType){r(this.sMetaPath+"/$Type")}i(this.sMetaPath,this.mQueryOptions);this.oTypePromise=s.all(e).then(function(){return t})}return this.oTypePromise};p.prototype.getMeasureRangePromise=function(){return undefined};p.prototype.getValue=function(e){throw new Error("Unsupported operation")};p.prototype.getOriginalResourcePath=function(e){return this.fnGetOriginalResourcePath&&this.fnGetOriginalResourcePath(e)||this.sResourcePath};p.prototype.hasChangeListeners=function(){return!r(this.mChangeListeners)};p.prototype.hasPendingChangesForPath=function(e){return Object.keys(this.mPatchRequests).some(function(t){return c(t,e)})||Object.keys(this.mPostRequests).some(function(t){return c(t,e)})};p.prototype.patch=function(n,i){var r=this;return this.fetchValue(e.$cached,n).then(function(e){t.updateExisting(r.mChangeListeners,n,e,i);return e})};p.prototype.refreshSingle=function(n,i,r,o){var a=this;return this.fetchValue(e.$cached,i).then(function(e){var u=t.getPrivateAnnotation(e[r],"predicate"),h=t.buildPath(a.sResourcePath,i,u),l=Object.assign({},t.getQueryOptionsForPath(a.mQueryOptions,i));delete l["$apply"];delete l["$count"];delete l["$filter"];delete l["$orderby"];delete l["$search"];h+=a.oRequestor.buildQueryString(a.sMetaPath,l,false,a.bSortExpandSelect);a.bSentReadRequest=true;return s.all([a.oRequestor.request("GET",h,n,undefined,undefined,o),a.fetchTypes()]).then(function(t){var n=t[0];a.replaceElement(e,r,u,n,t[1],i);return n})})};p.prototype.refreshSingleWithRemove=function(n,i,r,o,a){var u=this;return s.all([this.fetchValue(e.$cached,i),this.fetchTypes()]).then(function(e){var s=e[0],h=s[r],l=t.getPrivateAnnotation(h,"predicate"),f=Object.assign({},t.getQueryOptionsForPath(u.mQueryOptions,i)),c=f["$filter"],d=t.buildPath(u.sResourcePath,i),p=e[1];delete f["$count"];delete f["$orderby"];f["$filter"]=(c?"("+c+") and ":"")+t.getKeyFilter(h,u.sMetaPath,p);d+=u.oRequestor.buildQueryString(u.sMetaPath,f,false,u.bSortExpandSelect);u.bSentReadRequest=true;return u.oRequestor.request("GET",d,n,undefined,undefined,o).then(function(e){if(e.value.length>1){throw new Error("Unexpected server response, more than one entity returned.")}else if(e.value.length===0){u.removeElement(s,r,l,i);u.oRequestor.getModelInterface().reportBoundMessages(u.sResourcePath,[],[i+l]);a()}else{u.replaceElement(s,r,l,e.value[0],p,i)}})})};p.prototype.registerChange=function(e,n){this.checkActive();t.addByPath(this.mChangeListeners,e,n)};p.prototype.removeElement=function(e,n,i,r){var s,o;n=p.getElementIndex(e,i,n);s=e[n];e.splice(n,1);delete e.$byPredicate[i];o=t.getPrivateAnnotation(s,"transientPredicate");if(o){e.$created-=1;delete e.$byPredicate[o]}else if(!r){this.iLimit-=1;this.adjustReadRequests(n,-1)}f(this.mChangeListeners,r,e,-1);return n};p.prototype.removePendingRequest=function(){this.oPendingRequestsPromise.$count-=1;if(!this.oPendingRequestsPromise.$count){this.oPendingRequestsPromise.$resolve();this.oPendingRequestsPromise=null}};p.prototype.replaceElement=function(e,n,i,r,s,o){var a,u;n=p.getElementIndex(e,i,n);a=e[n];e[n]=e.$byPredicate[i]=r;u=t.getPrivateAnnotation(a,"transientPredicate");if(u){r["@$ui5.context.isTransient"]=false;e.$byPredicate[u]=r;t.setPrivateAnnotation(r,"transientPredicate",u)}this.visitResponse(r,s,t.getMetaPath(t.buildPath(this.sMetaPath,o)),o+i)};p.prototype.resetChangesForPath=function(e){var n=this;Object.keys(this.mPatchRequests).forEach(function(t){var i,r;if(c(t,e)){r=n.mPatchRequests[t];for(i=r.length-1;i>=0;i-=1){n.oRequestor.removePatch(r[i])}delete n.mPatchRequests[t]}});Object.keys(this.mPostRequests).forEach(function(i){var r,s,o;if(c(i,e)){r=n.mPostRequests[i];for(s=r.length-1;s>=0;s-=1){o=t.getPrivateAnnotation(r[s],"transient");n.oRequestor.removePost(o,r[s])}delete n.mPostRequests[i]}})};p.prototype.setActive=function(e){this.bActive=e;if(!e){this.mChangeListeners={}}};p.prototype.setQueryOptions=function(e){if(this.bSentReadRequest){throw new Error("Cannot set query options: Cache has already sent a read request")}this.mQueryOptions=e;this.sQueryString=this.oRequestor.buildQueryString(this.sMetaPath,e,false,this.bSortExpandSelect)};p.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.sQueryString};p.prototype.update=function(n,r,a,u,h,l,f,c,d){var P,g=r.split("/"),y,m=this;try{P=this.fetchValue(e.$cached,l)}catch(e){if(!e.$cached){throw e}P=s.resolve({"@odata.etag":"*"})}return P.then(function(e){var P=t.buildPath(l,r),R=n.getGroupId(),v,$,q,E,b,w=p.makeUpdateData(g,a);function M(){t.removeByPath(m.mPatchRequests,P,$);t.updateExisting(m.mChangeListeners,l,e,p.makeUpdateData(g,v))}function S(n,i){var r;function o(){r=m.oRequestor.lockGroup(R,m,true);if(d){d()}}$=m.oRequestor.request("PATCH",h,n,{"If-Match":e},w,o,M,undefined,t.buildPath(m.getOriginalResourcePath(e),l),i);t.addByPath(m.mPatchRequests,P,$);return s.all([$,m.fetchTypes()]).then(function(n){var i=n[0];t.removeByPath(m.mPatchRequests,P,$);if(!c){m.visitResponse(i,n[1],t.getMetaPath(t.buildPath(m.sMetaPath,l)),l)}t.updateExisting(m.mChangeListeners,l,e,c?{"@odata.etag":i["@odata.etag"]}:i)},function(n){var i=R;t.removeByPath(m.mPatchRequests,P,$);if(!u||n.canceled){throw n}u(n);switch(m.oRequestor.getGroupSubmitMode(R)){case"API":break;case"Auto":if(!m.oRequestor.hasChanges(R,e)){i="$parked."+R}break;default:throw n}r.unlock();r=undefined;return S(m.oRequestor.lockGroup(i,m,true,true),true)}).finally(function(){if(r){r.unlock()}})}if(!e){throw new Error("Cannot update '"+r+"': '"+l+"' does not exist")}E=t.getPrivateAnnotation(e,"transient");if(E){if(E===true){throw new Error("No 'update' allowed while waiting for server response")}if(E.indexOf("$parked.")===0){q=E;E=E.slice(8)}if(E!==R){throw new Error("The entity will be created via group '"+E+"'. Cannot patch via group '"+R+"'")}}v=t.drillDown(e,g);t.updateAll(m.mChangeListeners,l,e,w);if(f){y=f.split("/");f=t.buildPath(l,f);b=m.getValue(f);if(b===undefined){i.debug("Missing value for unit of measure "+f+" when updating "+P,m.toString(),"sap.ui.model.odata.v4.lib._Cache")}else{o.extend(true,E?e:w,p.makeUpdateData(y,b))}}if(E){if(q){t.setPrivateAnnotation(e,"transient",E);m.oRequestor.relocate(q,e,E)}n.unlock();return Promise.resolve()}m.oRequestor.relocateAll("$parked."+R,R,e);h+=m.oRequestor.buildQueryString(m.sMetaPath,m.mQueryOptions,true);return S(n)})};p.prototype.visitResponse=function(e,n,i,r,s,o){var h,l=false,f={},c=this.oRequestor.getServiceUrl()+this.sResourcePath,p=this;function P(e,n,i){l=true;if(e&&e.length){f[n]=e;e.forEach(function(e){if(e.longtextUrl){e.longtextUrl=t.makeAbsolute(e.longtextUrl,i)}})}}function g(e,n){return n?t.makeAbsolute(n,e):e}function y(e,n,i,r){var s={},a,u,l,f;for(a=0;a<e.length;a+=1){l=e[a];u=i===""?o+a:a;if(l&&typeof l==="object"){m(l,n,i,r,u);f=t.getPrivateAnnotation(l,"predicate");if(!i){h.push(f||u.toString())}if(f){s[f]=l;e.$byPredicate=s}}}}function m(e,i,o,l,f){var c,R,v=n[i],$=v&&v[u]&&v[u].$Path,q;l=g(l,e["@odata.context"]);R=p.calculateKeyPredicate(e,n,i);if(f!==undefined){o=t.buildPath(o,R||f)}else if(!s&&R){c=a.exec(o);if(c){o=o.slice(0,-c[0].length)+R}}if(r&&!h){h=[o]}if($){q=t.drillDown(e,$.split("/"));if(q!==undefined){P(q,o,l)}}Object.keys(e).forEach(function(n){var r,s=i+"/"+n,a=e[n],u=t.buildPath(o,n);if(n.endsWith("@odata.mediaReadLink")){e[n]=t.makeAbsolute(a,l)}if(n.includes("@")){return}if(Array.isArray(a)){a.$created=0;a.$count=undefined;r=e[n+"@odata.count"];if(r){d({},"",a,r)}else if(!e[n+"@odata.nextLink"]){d({},"",a,a.length)}y(a,s,u,g(l,e[n+"@odata.context"]))}else if(a&&typeof a==="object"){m(a,s,u,l)}})}if(o!==undefined){h=[];y(e.value,i||this.sMetaPath,"",g(c,e["@odata.context"]))}else if(e&&typeof e==="object"){m(e,i||this.sMetaPath,r||"",c)}if(l){this.oRequestor.getModelInterface().reportBoundMessages(this.getOriginalResourcePath(e),f,h)}};function P(e,t,n,i,r){p.call(this,e,t,n,i,function(){return r});this.sContext=undefined;this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.aElements.$tail=undefined;this.iLimit=Infinity;this.aReadRequests=[];this.oSyncPromiseAll=undefined}P.prototype=Object.create(p.prototype);P.prototype.adjustReadRequests=function(e,t){this.aReadRequests.forEach(function(n){if(n.iStart>=e){n.iStart+=t;n.iEnd+=t}})};P.prototype.fetchValue=function(e,t,n,i,r){var o,a=this;e.unlock();if(!this.oSyncPromiseAll){o=this.aElements.$tail?this.aElements.concat(this.aElements.$tail):this.aElements;this.oSyncPromiseAll=s.all(o)}return this.oSyncPromiseAll.then(function(){a.registerChange(t,i);return a.drillDown(a.aElements,t,r?e.getUnlockedCopy():undefined)})};P.prototype.fill=function(e,t,n){var i,r=Math.max(this.aElements.length,1024);if(n>r){if(this.aElements.$tail&&e){throw new Error("Cannot fill from "+t+" to "+n+", $tail already in use, # of elements is "+this.aElements.length)}this.aElements.$tail=e;n=this.aElements.length}for(i=t;i<n;i+=1){this.aElements[i]=e}this.oSyncPromiseAll=undefined};P.prototype.getQueryString=function(){var e=Object.assign({},this.mQueryOptions),n,i,r=e["$filter"],s,o,a=[],u=this.sQueryString,h;for(s=0;s<this.aElements.$created;s+=1){n=this.aElements[s];if(!n["@$ui5.context.isTransient"]){h=h||this.fetchTypes().getResult();o=t.getKeyFilter(n,this.sMetaPath,h);if(o){a.push(o)}}}if(a.length){i="not ("+a.join(" or ")+")";if(r){e["$filter"]="("+r+") and "+i;u=this.oRequestor.buildQueryString(this.sMetaPath,e,false,this.bSortExpandSelect)}else{u+=(u?"&":"?")+"$filter="+t.encode(i,false)}}return u};P.prototype.getReadRange=function(e,t,n){var i=this.aElements;function r(e,t){var n;for(n=e;n<t;n+=1){if(i[n]===undefined){return true}}return false}if(r(e+t,e+t+n/2)){t+=n}if(r(Math.max(e-n/2,0),e)){t+=n;e-=n;if(e<0){t+=e;if(isNaN(t)){t=Infinity}e=0}}return{length:t,start:e}};P.prototype.getResourcePath=function(e,t){var n=this.aElements.$created,i=this.getQueryString(),r=i?"&":"?",s=t-e,o=this.sResourcePath+i;if(e<n){throw new Error("Must not request created element")}e-=n;if(e>0||s<Infinity){o+=r+"$skip="+e}if(s<Infinity){o+="&$top="+s}return o};P.prototype.getValue=function(e){var t=this.drillDown(this.aElements,e);if(t.isFulfilled()){return t.getResult()}};P.prototype.handleResponse=function(e,n,i,r){var s=-1,o,a=this.aElements.$created,u,h,l=this.aElements.$count,f,c=i.value.length;this.sContext=i["@odata.context"];this.visitResponse(i,r,undefined,undefined,undefined,e);for(h=0;h<c;h+=1){u=i.value[h];this.aElements[e+h]=u;f=t.getPrivateAnnotation(u,"predicate");if(f){this.aElements.$byPredicate[f]=u}}o=i["@odata.count"];if(o){this.iLimit=s=parseInt(o)}if(i["@odata.nextLink"]){if(n<this.aElements.length){for(h=e+c;h<n;h+=1){delete this.aElements[h]}}else{this.aElements.length=e+c}}else if(c<n-e){if(s===-1){s=l&&l-a}s=Math.min(s!==undefined?s:Infinity,e-a+c);this.aElements.length=a+s;this.iLimit=s;if(!o&&s>0&&!this.aElements[s-1]){s=undefined}}if(s!==-1){d(this.mChangeListeners,"",this.aElements,s!==undefined?s+a:undefined)}};P.prototype.read=function(e,t,n,i,r){var o,a,u,h,l=-1,f=this.oPendingRequestsPromise||this.aElements.$tail,c,d=this;if(e<0){throw new Error("Illegal index "+e+", must be >= 0")}if(t<0){throw new Error("Illegal length "+t+", must be >= 0")}if(f){return f.then(function(){return d.read(e,t,n,i,r)})}c=this.getReadRange(e,t,n);h=Math.min(c.start+c.length,this.aElements.$created+this.iLimit);a=Math.min(h,Math.max(c.start,this.aElements.length)+1);for(o=c.start;o<a;o+=1){if(this.aElements[o]!==undefined){if(l>=0){this.requestElements(l,o,i.getUnlockedCopy(),r);r=undefined;l=-1}}else if(l<0){l=o}}if(l>=0){this.requestElements(l,h,i.getUnlockedCopy(),r)}i.unlock();u=this.aElements.slice(e,h);if(this.aElements.$tail){u.push(this.aElements.$tail)}return s.all(u).then(function(){var t;d.checkActive();t={"@odata.context":d.sContext,value:d.aElements.slice(e,h)};t.value.$count=d.aElements.$count;return t})};P.prototype.requestElements=function(e,t,n,i){var r,o={iEnd:t,iStart:e},a=this;this.aReadRequests.push(o);r=s.all([this.oRequestor.request("GET",this.getResourcePath(e,t),n,undefined,undefined,i),this.fetchTypes()]).then(function(e){if(a.aElements.$tail===r){a.aElements.$tail=undefined}a.handleResponse(o.iStart,o.iEnd,e[0],e[1])}).catch(function(e){a.fill(undefined,o.iStart,o.iEnd);throw e}).finally(function(){a.aReadRequests.splice(a.aReadRequests.indexOf(o),1)});this.bSentReadRequest=true;this.fill(r,e,t)};P.prototype.requestSideEffects=function(e,n,i,r,o){var a,u=[],h,l,f=this.fetchTypes().getResult(),c=this,d;function p(e){var n=t.getKeyFilter(e,c.sMetaPath,f);u.push(n);return n}if(this.oPendingRequestsPromise){return this.oPendingRequestsPromise.then(function(){return c.requestSideEffects(e,n,i,r,o)})}h=t.intersectQueryOptions(this.mLateQueryOptions||this.mQueryOptions,n,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath,i,"",true);if(!h){return s.resolve()}if(o===undefined){if(!p(this.aElements[r])){return null}}else{for(d=0;d<this.aElements.length;d+=1){a=this.aElements[d];if(!a||t.hasPrivateAnnotation(a,"transient")){continue}if((d<r||d>=r+o)&&!t.hasPrivateAnnotation(a,"transientPredicate")){delete this.aElements.$byPredicate[t.getPrivateAnnotation(a,"predicate")];delete this.aElements[d];continue}if(!p(a)){return null}}this.aElements.length=o?Math.min(r+o,this.aElements.length):this.aElements.$created;if(!u.length){return s.resolve()}}h.$filter=u.join(" or ");t.selectKeyProperties(h,f[this.sMetaPath]);delete h.$count;delete h.$orderby;delete h.$search;l=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,h,false,true);return this.oRequestor.request("GET",l,e).then(function(e){var n,i,r,s;if(e.value.length!==u.length){throw new Error("Expected "+u.length+" row(s), but instead saw "+e.value.length)}c.visitResponse(e,f,undefined,"",false,NaN);for(r=0,s=e.value.length;r<s;r+=1){n=e.value[r];i=t.getPrivateAnnotation(n,"predicate");t.updateAll(c.mChangeListeners,i,c.aElements.$byPredicate[i],n)}})};function g(e,t,n){p.call(this,e,t,n);this.oPromise=null}g.prototype=Object.create(p.prototype);g.prototype._delete=function(){throw new Error("Unsupported")};g.prototype.create=function(){throw new Error("Unsupported")};g.prototype.fetchValue=function(e,t,n,i){var r=this;if(this.oPromise){e.unlock()}else{this.oPromise=s.resolve(this.oRequestor.request("GET",this.sResourcePath+this.sQueryString,e,undefined,undefined,n,undefined,this.sMetaPath));this.bSentReadRequest=true}return this.oPromise.then(function(e){r.registerChange("",i);return e.value})};g.prototype.update=function(){throw new Error("Unsupported")};function y(e,t,n,i,r,s,o,a){p.apply(this,arguments);this.bFetchOperationReturnType=a;this.sMetaPath=o||this.sMetaPath;this.bPost=s;this.bPosting=false;this.oPromise=null}y.prototype=Object.create(p.prototype);y.prototype.fetchValue=function(e,t,n,i,r){var o=this.sResourcePath+this.sQueryString,a=this;if(this.oPromise){e.unlock()}else{if(this.bPost){throw new Error("Cannot fetch a value before the POST request")}this.oPromise=s.all([this.oRequestor.request("GET",o,e,undefined,undefined,n,undefined,this.sMetaPath),this.fetchTypes()]).then(function(e){a.visitResponse(e[0],e[1],a.bFetchOperationReturnType?a.sMetaPath+"/$Type":undefined);return e[0]});this.bSentReadRequest=true}return this.oPromise.then(function(n){a.registerChange(t,i);if(n["$ui5.deleted"]){throw new Error("Cannot read a deleted entity")}return a.drillDown(n,t,r?e.getUnlockedCopy():undefined)})};y.prototype.getValue=function(e){var t;if(this.oPromise&&this.oPromise.isFulfilled()){t=this.drillDown(this.oPromise.getResult(),e);if(t.isFulfilled()){return t.getResult()}}};y.prototype.post=function(e,t,n){var i,r="POST",o=this;if(!this.bPost){throw new Error("POST request not allowed")}if(this.bPosting){throw new Error("Parallel POST requests not allowed")}if(n){i=e.getGroupId();this.oRequestor.relocateAll("$parked."+i,i,n)}if(t){r=t["X-HTTP-Method"]||r;delete t["X-HTTP-Method"];if(this.oRequestor.isActionBodyOptional()&&!Object.keys(t).length){t=undefined}}this.oPromise=s.all([this.oRequestor.request(r,this.sResourcePath+this.sQueryString,e,{"If-Match":n},t),this.fetchTypes()]).then(function(e){o.bPosting=false;o.visitResponse(e[0],e[1],o.bFetchOperationReturnType?o.sMetaPath+"/$Type":undefined);return e[0]},function(e){o.bPosting=false;throw e});this.bPosting=true;return this.oPromise};y.prototype.requestSideEffects=function(n,i,r,o){var a=this.oPromise,u=a&&t.intersectQueryOptions(this.mLateQueryOptions||this.mQueryOptions,i,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath+"/$Type",r),h,l=this;if(!u){return s.resolve()}o=(o||this.sResourcePath)+this.oRequestor.buildQueryString(this.sMetaPath,u,false,true);h=s.all([this.oRequestor.request("GET",o,n),this.fetchTypes(),this.fetchValue(e.$cached,"")]).then(function(e){var n=e[0],i=e[2];l.visitResponse(n,e[1]);t.updateAll(l.mChangeListeners,"",i,n);return i});this.oPromise=h.catch(function(){return a});return h};p.create=function(e,t,n,i,r){return new P(e,t,n,i,r)};p.createProperty=function(e,t,n){return new g(e,t,n)};p.createSingle=function(e,t,n,i,r,s,o,a){return new y(e,t,n,i,r,s,o,a)};p.from$skip=function(e,t){return h.test(e)?t.$created+Number(e):e};p.getElementIndex=function(e,n,i){var r=e[i];if(!r||t.getPrivateAnnotation(r,"predicate")!==n){i=e.indexOf(e.$byPredicate[n])}return i};p.makeUpdateData=function(e,t){return e.reduceRight(function(e,t){var n={};n[t]=e;return n},t)};return p},false);