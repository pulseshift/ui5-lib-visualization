/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ODataBinding","./SubmitMode","./lib/_Helper","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","sap/ui/thirdparty/jquery"],function(e,t,n,r,o,i,s){"use strict";function a(){e.call(this);this.mAggregatedQueryOptions={};this.bAggregatedQueryOptionsInitial=true;this.aChildCanUseCachePromises=[];this.iPatchCounter=0;this.bPatchSuccess=true;this.oReadGroupLock=undefined;this.oRefreshPromise=null;this.oResumePromise=undefined}e(a.prototype);var h="sap.ui.model.odata.v4.ODataParentBinding";a.prototype.attachPatchCompleted=function(e,t){this.attachEvent("patchCompleted",e,t)};a.prototype.detachPatchCompleted=function(e,t){this.detachEvent("patchCompleted",e,t)};a.prototype.firePatchCompleted=function(e){if(this.iPatchCounter===0){throw new Error("Completed more PATCH requests than sent")}this.iPatchCounter-=1;this.bPatchSuccess=this.bPatchSuccess&&e;if(this.iPatchCounter===0){this.fireEvent("patchCompleted",{success:this.bPatchSuccess});this.bPatchSuccess=true}};a.prototype.attachPatchSent=function(e,t){this.attachEvent("patchSent",e,t)};a.prototype.detachPatchSent=function(e,t){this.detachEvent("patchSent",e,t)};a.prototype.firePatchSent=function(){this.iPatchCounter+=1;if(this.iPatchCounter===1){this.fireEvent("patchSent")}};a.prototype._findEmptyPathParentContext=function(e){if(this.sPath===""&&this.oContext.getBinding){return this.oContext.getBinding()._findEmptyPathParentContext(this.oContext)}return e};a.prototype.aggregateQueryOptions=function(e,t){var n=s.extend(true,{},this.mAggregatedQueryOptions);function r(e,n,o){var i,s;function a(o){if(e.$expand[o]){return r(e.$expand[o],n.$expand[o],true)}if(t){return false}e.$expand[o]=i[o];return true}function h(n){if(e.$select.indexOf(n)<0){if(t){return!o}e.$select.push(n)}return true}i=n.$expand;if(i){e.$expand=e.$expand||{};if(!Object.keys(i).every(a)){return false}}s=n.$select;if(s){e.$select=e.$select||[];if(!s.every(h)){return false}}if(n.$count){e.$count=true}return Object.keys(n).concat(Object.keys(e)).every(function(t){if(t==="$count"||t==="$expand"||t==="$select"||!o&&!(t in n)){return true}return n[t]===e[t]})}if(r(n,e)){this.mAggregatedQueryOptions=n;return true}return false};a.prototype.changeParameters=function(e){var t=s.extend(true,{},this.mParameters),n,r,o=this;function a(t){if(o.oModel.bAutoExpandSelect&&t in e){throw new Error("Cannot change $expand or $select parameter in "+"auto-$expand/$select mode: "+t+"="+JSON.stringify(e[t]))}}function h(e){if(e==="$filter"||e==="$search"){n=i.Filter}else if(e==="$orderby"&&n!==i.Filter){n=i.Sort}else if(!n){n=i.Change}}if(!e){throw new Error("Missing map of binding parameters")}a("$expand");a("$select");if(this.hasPendingChanges()){throw new Error("Cannot change parameters due to pending changes")}for(r in e){if(r.indexOf("$$")===0){throw new Error("Unsupported parameter: "+r)}if(e[r]===undefined&&t[r]!==undefined){h(r);delete t[r]}else if(t[r]!==e[r]){h(r);if(typeof e[r]==="object"){t[r]=s.extend(true,{},e[r])}else{t[r]=e[r]}}}if(n){this.createReadGroupLock(this.getGroupId(),true);this.applyParameters(t,n)}};a.prototype.checkUpdateInternal=function(e){var t=this;function n(){return o.all(t.getDependentBindings().map(function(e){return e.checkUpdateInternal()}))}if(e!==undefined){throw new Error("Unsupported operation: "+h+"#checkUpdateInternal must not"+" be called with parameters")}return this.oCachePromise.then(function(e){if(e&&t.bRelative){return t.fetchResourcePath(t.oContext).then(function(r){if(e.$resourcePath===r){return n()}return t.refreshInternal("")})}return n()})};a.prototype.createInCache=function(e,t,r,o,i,s,a,h){var u=this;return this.oCachePromise.then(function(d){if(d){return d.create(e,t,r,o,i,s,a,h).then(function(e){if(d.$resourcePath){delete u.mCacheByResourcePath[d.$resourcePath]}return e})}return u.oContext.getBinding().createInCache(e,t,n.buildPath(u.oContext.iIndex,u.sPath,r),o,i,s,a,h)})};a.prototype.createReadGroupLock=function(e,t,n){var o,i=this;function s(){sap.ui.getCore().addPrerenderingTask(function(){n-=1;if(n>0){Promise.resolve().then(s)}else if(i.oReadGroupLock===o){r.debug("Timeout: unlocked "+o,null,h);i.removeReadGroupLock()}})}this.removeReadGroupLock();this.oReadGroupLock=o=this.lockGroup(e,t);if(t){n=2+(n||0);s()}};a.prototype.createRefreshPromise=function(){var e,t;e=new Promise(function(e){t=e});e.$resolve=t;this.oRefreshPromise=e;return e};a.prototype.deleteFromCache=function(e,t,r,o,i){var s;if(this.oCache===undefined){throw new Error("DELETE request not allowed")}if(this.oCache){s=e.getGroupId();if(!this.oModel.isAutoGroup(s)&&!this.oModel.isDirectGroup(s)){throw new Error("Illegal update group ID: "+s)}return this.oCache._delete(e,t,r,o,i)}return this.oContext.getBinding().deleteFromCache(e,t,n.buildPath(this.oContext.iIndex,this.sPath,r),o,i)};a.prototype.destroy=function(){this.aChildCanUseCachePromises=[];this.removeReadGroupLock();this.oResumePromise=undefined;e.prototype.destroy.apply(this)};a.prototype.fetchIfChildCanUseCache=function(e,t,i){var a=this.getBaseForPathReduction(),u,d,c,p,f=t[0]==="#",g=this.oModel.getMetaModel(),l,P=this.oModel.resolve(t,e),C=this.oModel.resolve(this.sPath,this.oContext),y=C.indexOf("(...)")>=0,m=this;function v(){if(f){return g.fetchObject(p.slice(0,p.lastIndexOf("/")+1))}return g.fetchObject(p).then(function(e){if(e&&e.$kind==="NavigationProperty"){return g.fetchObject(p+"/").then(function(){return e})}return e})}if(y||this.getRootBinding().isSuspended()){return o.resolve(P)}d=this.oCachePromise.isRejected()||this.oCachePromise.isFulfilled()&&(!this.oCache||this.oCache.bSentReadRequest);u=g.getMetaPath(e.getPath());p=g.getMetaPath(P);l=[this.doFetchQueryOptions(this.oContext),v(),i];c=o.all(l).then(function(e){var c,l=e[2],y,v=e[0],R=e[1],b=g.getReducedPath(P,a);if(t==="$count"||t.slice(-7)==="/$count"||t[0]==="@"){return o.resolve(b)}if(n.getRelativePath(b,C)===undefined){return m.oContext.getBinding().fetchIfChildCanUseCache(m.oContext,n.getRelativePath(P,m.oContext.getPath()),i)}c=n.getRelativePath(n.getMetaPath(b),u);if(m.bAggregatedQueryOptionsInitial){m.selectKeyProperties(v,u);m.mAggregatedQueryOptions=s.extend(true,{},v);m.bAggregatedQueryOptionsInitial=false}if(f){y={$select:[c.slice(1)]};return m.aggregateQueryOptions(y,d)?b:undefined}if(c===""||R&&(R.$kind==="Property"||R.$kind==="NavigationProperty")){y=n.wrapChildQueryOptions(u,c,l,m.oModel.oRequestor.getModelInterface().fetchMetadata);if(y){return m.aggregateQueryOptions(y,d)?b:undefined}return undefined}if(c==="value"){return m.aggregateQueryOptions(l,d)?b:undefined}r.error("Failed to enhance query options for auto-$expand/$select as the path '"+p+"' does not point to a property",JSON.stringify(R),h);return undefined});this.aChildCanUseCachePromises.push(c);this.oCachePromise=o.all([this.oCachePromise,c]).then(function(e){var t=e[0];if(t&&!t.bSentReadRequest){t.setQueryOptions(s.extend(true,{},m.oModel.mUriParameters,m.mAggregatedQueryOptions))}return t});this.oCachePromise.catch(function(e){m.oModel.reportError(m+": Failed to enhance query options for "+"auto-$expand/$select for child "+t,h,e)});return c};a.prototype.getBaseForPathReduction=function(){var e,n;if(!this.isRoot()){e=this.oContext.getBinding();n=e.getUpdateGroupId();if(n===this.getUpdateGroupId()||this.oModel.getGroupProperty(n,"submit")!==t.API){return e.getBaseForPathReduction()}}return this.oModel.resolve(this.sPath,this.oContext)};a.prototype.getQueryOptionsForPath=function(e,t){if(Object.keys(this.mParameters).length){return n.getQueryOptionsForPath(this.mQueryOptions,e)}t=t||this.oContext;if(!this.bRelative||!t.getQueryOptionsForPath){return{}}return t.getQueryOptionsForPath(n.buildPath(this.sPath,e))};a.prototype.getResumePromise=function(){return this.oResumePromise};a.prototype.hasPendingChangesInDependents=function(){var e=this.getDependentBindings();return e.some(function(e){var t=e.oCache,n;if(t!==undefined){if(t&&t.hasPendingChangesForPath("")){return true}}else if(e.hasPendingChangesForPath("")){return true}if(e.mCacheByResourcePath){n=Object.keys(e.mCacheByResourcePath).some(function(t){return e.mCacheByResourcePath[t].hasPendingChangesForPath("")});if(n){return true}}return e.hasPendingChangesInDependents()})||this.oModel.withUnresolvedBindings("hasPendingChangesInCaches",this.oModel.resolve(this.sPath,this.oContext).slice(1))};a.prototype.isPatchWithoutSideEffects=function(){return this.mParameters.$$patchWithoutSideEffects||!this.isRoot()&&this.oContext&&this.oContext.getBinding().isPatchWithoutSideEffects()};a.prototype.isMeta=function(){return false};a.prototype.refreshDependentBindings=function(e,t,n,r){return o.all(this.getDependentBindings().map(function(o){return o.refreshInternal(e,t,n,r)}))};a.prototype.removeReadGroupLock=function(){if(this.oReadGroupLock){this.oReadGroupLock.unlock(true);this.oReadGroupLock=undefined}};a.prototype.refreshSuspended=function(e){if(e&&e!==this.getGroupId()){throw new Error(this+": Cannot refresh a suspended binding with group ID '"+e+"' (own group ID is '"+this.getGroupId()+"')")}this.setResumeChangeReason(i.Refresh)};a.prototype.resetChangesInDependents=function(e){this.getDependentBindings().forEach(function(t){e.push(t.oCachePromise.then(function(e){if(e){e.resetChangesForPath("")}t.resetInvalidDataState()}).unwrap());if(t.mCacheByResourcePath){Object.keys(t.mCacheByResourcePath).forEach(function(e){t.mCacheByResourcePath[e].resetChangesForPath("")})}t.resetChangesInDependents(e)})};a.prototype.resolveRefreshPromise=function(e){if(this.oRefreshPromise){this.oRefreshPromise.$resolve(e);this.oRefreshPromise=null}return e};a.prototype.resume=function(){var e=this;if(this.oOperation){throw new Error("Cannot resume an operation binding: "+this)}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot resume a relative binding: "+this)}if(!this.bSuspended){throw new Error("Cannot resume a not suspended binding: "+this)}this.createReadGroupLock(this.getGroupId(),true,1);sap.ui.getCore().addPrerenderingTask(function(){e.bSuspended=false;if(e.oResumePromise){e.resumeInternal(true);e.oResumePromise.$resolve();e.oResumePromise=undefined}})};a.prototype.selectKeyProperties=function(e,t){n.selectKeyProperties(e,this.oModel.getMetaModel().getObject(t+"/"))};a.prototype.suspend=function(){var e;if(this.oOperation){throw new Error("Cannot suspend an operation binding: "+this)}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot suspend a relative binding: "+this)}if(this.bSuspended){throw new Error("Cannot suspend a suspended binding: "+this)}if(this.hasPendingChanges()){throw new Error("Cannot suspend a binding with pending changes: "+this)}this.bSuspended=true;this.oResumePromise=new o(function(t,n){e=t});this.oResumePromise.$resolve=e;this.removeReadGroupLock()};a.prototype.updateAggregatedQueryOptions=function(e){var t=Object.keys(e),n=this;if(this.mAggregatedQueryOptions){t=t.concat(Object.keys(this.mAggregatedQueryOptions));t.forEach(function(t){if(t==="$select"||t==="$expand"){return}if(e[t]===undefined){delete n.mAggregatedQueryOptions[t]}else{n.mAggregatedQueryOptions[t]=e[t]}})}};a.prototype.visitSideEffects=function(e,t,r,o,i,s){var a=r?this.oModel.getDependentBindings(r):this.getDependentBindings();a.forEach(function(r){var a=n.buildPath(s,n.getMetaPath(r.getPath())),h;if(r.oCache){h=n.stripPathPrefix(a,t);if(h.length){i.push(r.requestSideEffects(e,h))}}else if(o[a]){i.push(r.refreshInternal("",e))}else{r.visitSideEffects(e,t,null,o,i,a)}})};function u(e){if(this){a.apply(this,arguments)}else{s.extend(e,a.prototype)}}u.prototype.destroy=a.prototype.destroy;u.prototype.hasPendingChangesForPath=a.prototype.hasPendingChangesForPath;return u},false);