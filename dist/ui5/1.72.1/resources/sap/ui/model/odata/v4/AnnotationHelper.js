/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_AnnotationHelperExpression"],function(e){"use strict";var t=/[\\\{\}:]/,n=/\/\$count$/,i=/\$(?:(?:Annotation)|(?:(?:Navigation)?Property))?Path/,r=/^(.+?\/(\$(?:Annotation)?Path))(\/?)(.*)$/,o=/\$(?:Navigation)?PropertyPath/,a={format:function(t,n){var i,a=n.context.getModel(),l=n.context.getPath();function s(i){if(l.slice(-1)==="/"){l=l.slice(0,-1)}return e.getExpression({asExpression:false,complexBinding:true,ignoreAsPrefix:n.overload&&n.overload.$IsBound?n.overload.$Parameter[0].$Name+"/":"",model:a,path:l,prefix:i,value:t,$$valueAsPromise:true})}i=o.exec(l);if(i){throw new Error("Unsupported path segment "+i[0]+" in "+l)}i=r.exec(l);if(i&&l.length>i[1].length){if(r.test(i[4])){throw new Error("Only one $Path or $AnnotationPath segment is supported: "+l)}return a.fetchObject(i[1]).then(function(e){var t,n=i[2]==="$AnnotationPath",r=n?e.split("@")[0]:e;if(!n&&i[3]){r=r+"/"}else if(!r.endsWith("/")){t=r.lastIndexOf("/");r=t<0?"":r.slice(0,t+1)}return s(r)})}return s("")},getNavigationBinding:function(e){e=a.getNavigationPath(e);if(t.test(e)){throw new Error("Invalid OData identifier: "+e)}return e?"{"+e+"}":e},getNavigationPath:function(e){var t;if(!e||e[0]==="@"){return""}if(n.test(e)){return e.slice(0,-7)}t=e.indexOf("@");if(t>-1){e=e.slice(0,t)}if(e[e.length-1]==="/"){e=e.slice(0,-1)}if(e.indexOf(".")>-1){e=e.split("/").filter(function(e){return e.indexOf(".")<0}).join("/")}return e},getValueListType:function(e,t){var n=typeof e==="string"?"/"+t.schemaChildName+"/"+e:t.context.getPath();return t.$$valueAsPromise?t.context.getModel().fetchValueListType(n).unwrap():t.context.getModel().getValueListType(n)},isMultiple:function(e,t){var i;function r(e){return e===true}if(!e||e[0]==="@"){return false}if(n.test(e)){return true}i=e.indexOf("@");if(i>-1){e=e.slice(0,i)}if(e[e.length-1]!=="/"){e+="/"}e="/"+t.schemaChildName+"/"+e+"$isCollection";return t.$$valueAsPromise?t.context.getModel().fetchObject(e).then(r).unwrap():t.context.getObject(e)===true},label:function(e,t){var n;if(e.Label){return a.value(e.Label,{context:t.context.getModel().createBindingContext("Label",t.context)})}if(e.Value&&e.Value.$Path){n=t.context.getModel().createBindingContext("Value/$Path@com.sap.vocabularies.Common.v1.Label",t.context);if(t.$$valueAsPromise){return n.getModel().fetchObject("",n).then(function(e){return a.value(e,{context:n})}).unwrap()}return a.value(n.getObject(""),{context:n})}},resolve$Path:function(e){var t,n,r,o,a,l=e.getPath(),s,u;for(;;){a=l.match(i);if(!a){return l}r=a.index;t=r+a[0].length;s=l.slice(0,t);u=e.getModel().getObject(s);if(typeof u!=="string"){throw new Error("Cannot resolve "+s+" due to unexpected value "+u)}s=l.slice(0,r);n=s.indexOf("@");o=s.lastIndexOf("/",n);if(o===0){s=s.slice(0,n);if(n>1&&u){s+="/"}}else{s=s.slice(0,o+1)}l=s+u+l.slice(t)}},value:function(t,n){var i=n.context.getPath();if(i.slice(-1)==="/"){i=i.slice(0,-1)}return e.getExpression({asExpression:false,complexBinding:false,ignoreAsPrefix:n.overload&&n.overload.$IsBound?n.overload.$Parameter[0].$Name+"/":"",model:n.context.getModel(),path:i,prefix:"",value:t,$$valueAsPromise:n.$$valueAsPromise})}};return a},true);