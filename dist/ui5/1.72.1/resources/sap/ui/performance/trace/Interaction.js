/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/performance/Measurement","sap/ui/performance/XHRInterceptor","sap/base/util/now","sap/base/Log","sap/ui/thirdparty/URI"],function(e,t,n,i,r){"use strict";var s=window.location.host,o="INTERACTION",a=[],u=p();function d(e){var t=new r(e).host();return t&&t!==s}function p(e){return{event:"startup",trigger:"undetermined",component:"undetermined",appVersion:"undetermined",start:e||window.performance.timing.fetchStart,end:0,navigation:0,roundtrip:0,processing:0,duration:0,requests:[],measurements:[],sapStatistics:[],requestTime:0,networkTime:0,bytesSent:0,bytesReceived:0,requestCompression:undefined,busyDuration:0}}function c(e){if(e.start>u.start&&e.end<u.end){return e}}function f(e){var t,n,i;t=e.startTime>0&&e.startTime<=e.requestStart&&e.requestStart<=e.responseEnd;if(e.encodedBodySize!==undefined&&e.transferSize!==undefined){n=e.encodedBodySize===0;i=e.transferSize<e.encodedBodySize}return t&&!n&&!i}function g(e){this.end=e.responseEnd>this.end?e.responseEnd:this.end;u.requestTime+=e.responseEnd-e.startTime;if(this.roundtripHigherLimit<=e.startTime){u.navigation+=this.navigationHigherLimit-this.navigationLowerLimit;u.roundtrip+=this.roundtripHigherLimit-this.roundtripLowerLimit;this.navigationLowerLimit=e.startTime;this.roundtripLowerLimit=e.startTime}if(e.responseEnd>this.roundtripHigherLimit){this.roundtripHigherLimit=e.responseEnd}if(e.requestStart>this.navigationHigherLimit){this.navigationHigherLimit=e.requestStart}}function h(e){var t={start:e[0].startTime,end:e[0].responseEnd,navigationLowerLimit:e[0].startTime,navigationHigherLimit:e[0].requestStart,roundtripLowerLimit:e[0].startTime,roundtripHigherLimit:e[0].responseEnd};e.forEach(g,t);u.navigation+=t.navigationHigherLimit-t.navigationLowerLimit;u.roundtrip+=t.roundtripHigherLimit-t.roundtripLowerLimit;if(u.networkTime){var n=u.requestTime-u.networkTime;u.networkTime=n/e.length}else{u.networkTime=0}if(u.processing===0){var i=u.start-window.performance.timing.fetchStart;u.duration=t.end-i;u.processing=t.start-i}}function m(t){if(u){u.end=t;u.duration=u.processing;u.requests=window.performance.getEntriesByType("resource");u.completeRoundtrips=0;u.measurements=e.filterMeasurements(c,true);var n=u.requests.filter(f);if(n.length>0){h(n)}u.completeRoundtrips=n.length;var r=u.processing-u.navigation-u.roundtrip;u.processing=r>-1?r:0;u.completed=true;Object.freeze(u);a.push(u);i.info("Interaction step finished: trigger: "+u.trigger+"; duration: "+u.duration+"; requests: "+u.requests.length,"Interaction.js");u=null}}function l(e){var t,n;if(e){var i,r;i=sap.ui.require("sap/ui/core/Component");while(i&&e&&e.getParent){r=i.getOwnerComponentFor(e);if(r||e instanceof i){r=r||e;var s=r.getManifestEntry("sap.app");t=s&&s.id||r.getMetadata().getName();n=s&&s.applicationVersion&&s.applicationVersion.version}e=e.getParent()}}return{id:t?t:"undetermined",version:n?n:""}}var v=false,L=false,w,y,T=0;function I(){t.register(o,"send",function(){if(this.pendingInteraction){this.pendingInteraction.bytesSent+=arguments[0]?arguments[0].length:0}});t.register(o,"setRequestHeader",function(e,t){if(!this.requestHeaderLength){this.requestHeaderLength=0}this.requestHeaderLength+=(e+"").length+(t+"").length});t.register(o,"open",function(){if(!d(arguments[1])){this.addEventListener("readystatechange",S.bind(this))}this.pendingInteraction=u})}function S(){if(this.readyState===4&&this.pendingInteraction&&!this.pendingInteraction.completed){var e=this.getResponseHeader("content-length"),t=this.getResponseHeader("content-encoding")==="gzip",n=this.getResponseHeader("sap-perf-fesrec");this.pendingInteraction.bytesReceived+=e?parseInt(e):0;this.pendingInteraction.bytesReceived+=this.getAllResponseHeaders().length;this.pendingInteraction.bytesSent+=this.requestHeaderLength||0;this.pendingInteraction.requestCompression=t&&this.pendingInteraction.requestCompression!==false;this.pendingInteraction.networkTime+=n?Math.round(parseFloat(n,10)/1e3):0;var i=this.getResponseHeader("sap-statistics");if(i){var r=window.performance.getEntriesByType("resource");this.pendingInteraction.sapStatistics.push({url:this.responseURL,statistics:i,timing:r?r[r.length-1]:undefined})}delete this.requestHeaderLength;delete this.pendingInteraction}}var q={getAll:function(e){if(e){q.end(true)}return a},filter:function(e){var t=[];if(e){for(var n=0,i=a.length;n<i;n++){if(e(a[n])){t.push(a[n])}}}return t},getPending:function(){return u},clear:function(){a=[]},start:function(e,t){var r=n();if(u){m(r)}if(window.performance.clearResourceTimings){window.performance.clearResourceTimings()}var s=l(t);u=p(r);u.event=e;u.component=s.id;u.appVersion=s.version;u.start=r;if(t&&t.getId){u.trigger=t.getId()}i.info("Interaction step started: trigger: "+u.trigger+"; type: "+u.event,"Interaction.js")},end:function(e){if(u){if(!e){u.processing=n()-u.start}else{m(n())}}},getActive:function(){return v},setActive:function(e){if(e&&!v){I()}v=e},notifyStepStart:function(e,t){if(v){if(w&&!L||t){var n;if(t){n="startup"}else if(w.originalEvent){n=w.originalEvent.type}else{n=w.type}q.start(n,e);var i=q.getAll();var r=i[i.length-1];var s=q.getPending();u=s?s:u;if(q.onInteractionFinished&&r){q.onInteractionFinished(r,t)}w=null;L=true;setTimeout(function(){w=null;L=false},0)}}},notifyStepEnd:function(){if(v){if(y){clearTimeout(y)}y=setTimeout(q.end,1)}},notifyEventStart:function(e){w=v?e:null},notifyScrollEvent:function(e){if(v){if(!T){q.notifyEventStart(e)}else{clearTimeout(T)}T=setTimeout(function(){q.notifyStepStart();T=0},250)}},notifyEventEnd:function(){if(w){if(w.type.match(/^(mousedown|touchstart|keydown)$/)){q.end(true)}}},onInteractionFinished:null,setStepComponent:function(e){if(v&&u&&e&&!u.stepComponent){u.stepComponent=e}},addBusyDuration:function(e){if(v&&u){if(!u.busyDuration){u.busyDuration=0}u.busyDuration+=e}}};return q});