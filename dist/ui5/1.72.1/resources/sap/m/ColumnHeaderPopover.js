/*
 * ! OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/model/base/ManagedObjectModel","sap/m/Toolbar","sap/m/ResponsivePopover","sap/m/Button","sap/m/ToggleButton","sap/m/ToolbarSpacer","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/dom/containsOrEquals","sap/m/ColumnPopoverItem","sap/m/StandardListItem","sap/m/List"],function(e,t,o,n,i,s,r,a,l,p,u,c,g){"use strict";var h=e.extend("sap.m.ColumnHeaderPopover",{library:"sap.m",metadata:{properties:{},aggregations:{items:{type:"sap.m.ColumnPopoverItem",multiple:true,singularName:"item",bindable:true},_popover:{type:"sap.m.ResponsivePopover",multiple:false,visibility:"hidden"}},defaultAggregation:"items",associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}}});h.prototype.init=function(){this._bPopoverCreated=false;this._oShownCustomContent=null};h.prototype.exit=function(){this._oToolbar=null};h.prototype._createPopover=function(){var e=this;this._oShownCustomContent=null;var s=sap.ui.getCore().getLibraryResourceBundle("sap.m"),u=s.getText("COLUMNHEADERPOPOVER_CLOSE_BUTTON");var c=new n(this.getId()+"-popover",{showArrow:false,showHeader:false,placement:"Bottom",verticalScrolling:true,horizontalScrolling:false,ariaLabelledBy:this.getAriaLabelledBy(),beforeClose:function(t){if(e._oShownCustomContent){e._oShownCustomContent.setVisible(false);e._oShownCustomContent=null}e._cleanSelection(this)}});this.setAggregation("_popover",c);var g=new o(this.getId()+"-tb");c.addContent(g);var h=new a({path:"visible",operator:l.EQ,value1:true});var m=function(t,o){var n=o.getObject();var i;if(n.isA("sap.m.ColumnPopoverActionItem")){i=e._createActionItem(t,n)}else if(n.isA("sap.m.ColumnPopoverCustomItem")){i=e._createCustomItem(t,n)}else if(n.isA("sap.m.ColumnPopoverSortItem")){i=e._createSortItem(t,n)}n._sRelatedId=i.sId;i._sContentId=n._sContentId;i.destroy=function(){var t=this.getDomRef();if(t&&p(t,document.activeElement)){c.focus();c.removeContent(e._oShownCustomContent)}this.constructor.prototype.destroy.apply(this,arguments)};return i};g.bindAggregation("content",{path:"/items",filters:[h],length:5,factory:m});g.updateAggregation=function(e){if(this._oShownCustomContent){this._oShownCustomContent=null}o.prototype.updateAggregation.apply(this,arguments);var t=this.getContent();if(t.length<=2||!(t[t.length-2]instanceof r)){this.addContent(new r);this.addContent(new i({type:"Transparent",icon:"sap-icon://decline",tooltip:u,press:[c.close,c]}))}};var f=new t(this);g.setModel(f);this._oToolbar=g};h.prototype._createActionItem=function(e,t){var o=this;return new i(e,{icon:"{icon}",tooltip:"{text}",type:"Transparent",visible:"{visible}",press:function(){var e=o.getAggregation("_popover");if(o._oShownCustomContent){o._oShownCustomContent.setVisible(false);o._oShownCustomContent=null;o._cleanSelection(e,this)}t.firePress()}})};h.prototype._createCustomItem=function(e,t){var o=this;var n=this.getAggregation("_popover");var i=t.getContent();if(i){i.setVisible(false);t._sContentId=i.sId}n.addContent(i);return new s(e,{icon:"{icon}",type:"Transparent",tooltip:"{text}",visible:"{visible}",press:function(){if(o._oShownCustomContent){o._oShownCustomContent.setVisible(false)}if(this.getPressed()){o._cleanSelection(n,this);t.fireBeforeShowContent();if(i){i.setVisible(true);o._oShownCustomContent=i}}else{if(i){i.setVisible(false);o._oShownCustomContent=null}}}})};h.prototype._createSortItem=function(e,t){var o=this;var n=sap.ui.getCore().getLibraryResourceBundle("sap.m"),r=n.getText("COLUMNHEADERPOPOVER_SORT_BUTTON");var a=t.getSortChildren();if(a.length>1){var l=this.getAggregation("_popover");var p=new g;for(var u=0;u<a.length;u++){var h=new c({title:a[u].getText(),type:"Active"});p.addItem(h);h.data("key",a[u].getKey())}p.attachEvent("itemPress",function(e){l.close();var o=e.getParameter("listItem");t.fireSort({property:o.data("key")})});p.setVisible(false);l.addContent(p);return new s(e,{icon:"sap-icon://sort",type:"Transparent",tooltip:r,visible:"{visible}",press:function(){if(o._oShownCustomContent){o._oShownCustomContent.setVisible(false)}if(this.getPressed()){o._cleanSelection(l,this);if(p){p.setVisible(true);o._oShownCustomContent=p}}else{if(p){p.setVisible(false);o._oShownCustomContent=null}}}})}else{return new i(e,{icon:"sap-icon://sort",type:"Transparent",tooltip:r,visible:"{visible}",press:function(){var e=o.getAggregation("_popover");if(o._oShownCustomContent){o._oShownCustomContent.setVisible(false);o._oShownCustomContent=null;o._cleanSelection(e,this)}e.close();t.fireSort({property:a[0]?a[0].getKey():null})}})}};h.prototype._cleanSelection=function(e,t){var o=e.getContent()[0],n;n=o.getContent();if(n){n.forEach(function(e){if((!t||e!==t)&&e.getPressed&&e.getPressed()){e.setPressed(false)}})}};h.prototype.openBy=function(e){if(!this._bPopoverCreated){this._createPopover();this._bPopoverCreated=true}else{this._oToolbar.getBinding("content").refresh(true)}var t=this.getAggregation("_popover");if(!this._bAppendedToUIArea&&!this.getParent()){var o=sap.ui.getCore().getStaticAreaRef();o=sap.ui.getCore().getUIArea(o);o.addContent(this,true);this._bAppendedToUIArea=true}var n=e.getFocusDomRef();if(n){t.setOffsetY(-n.clientHeight);t.setContentWidth(n.clientWidth>128?n.clientWidth+"px":"128px")}t.openBy(e)};h.prototype.invalidate=function(t){var o=this.getAggregation("_popover");if(t===o){e.prototype.invalidate.apply(this,arguments)}return this};h.prototype.addAssociation=function(t,o,n){if(t==="ariaLabelledBy"){var i=this.getAggregation("_popover");i&&i.addAssociation(t,o,n)}return e.prototype.addAssociation.apply(this,arguments)};h.prototype.removeAssociation=function(t,o,n){if(t==="ariaLabelledBy"){var i=this.getAggregation("_popover");i&&i.removeAssociation(t,o,n)}return e.prototype.removeAssociation.apply(this,arguments)};h.prototype.removeAllAssociation=function(t,o){if(t==="ariaLabelledBy"){var n=this.getAggregation("_popover");n&&n.removeAllAssociation(t,o)}return e.prototype.removeAllAssociation.apply(this,arguments)};return h});